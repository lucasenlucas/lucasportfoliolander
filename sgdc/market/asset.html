<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SGDC Live ‚Äî Asset</title>

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700;800&display=swap" rel="stylesheet"/>
  <link rel="icon" href="https://groep8sgdc.nl/wp-content/uploads/2022/09/s-Gravendreef-scholen07-01-18-1.png"/>

  <style>
    :root{
      --bg:#0e1023; --panel:#171a37; --card:#141736; --text:#e8ecff; --muted:#a2a9d6;
      --good:#4bd37b; --bad:#ff6b6b; --border:rgba(255,255,255,.10); --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,sans-serif;background:var(--bg);color:var(--text)}
    .nav{max-width:1200px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;gap:10px}
    .back{border:1px solid var(--border);background:#ffffff12;padding:8px 10px;border-radius:10px;text-decoration:none;color:var(--text)}
    .spacer{flex:1}
    .balance{font-weight:800;color:var(--good)}
    .container{max-width:1200px;margin:0 auto;padding:16px}

    .head{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .title{font-weight:800;font-size:22px}
    .ticker{font-size:12px;color:var(--muted)}
    .pill{background:#ffffff1a;border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px}
    .pill.up{color:var(--good)} .pill.down{color:var(--bad)}

    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;margin-top:16px}
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }

    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:var(--shadow)}
    canvas{width:100%;height:260px;display:block}

    .tf{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    .btn{padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#ffffff12;color:var(--text);cursor:pointer}
    .btn.active{background:#ffffff22}

    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    input[type=number]{background:#0f1330;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .buy{background:linear-gradient(90deg,#37d87c,#2bb56a);border:none}
    .sell{background:#ffd66b;border:none;color:#0d0b06}
    .swap{background:#9c7cff;border:none}
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <script src="/js/bits.js"></script>
  <script src="/market/market.js"></script>

  <nav class="nav">
    <a class="back" href="/market/">‚Üê Terug</a>
    <div class="spacer"></div>
    <div class="balance">Bits: <span id="bitsHeader">0</span></div>
  </nav>

  <main class="container">
    <div class="head">
      <div id="icon" class="pill">üì¶</div>
      <div class="title" id="name">Asset</div>
      <div class="ticker" id="ticker">TICK</div>
      <div class="pill" id="dayDelta">+0.00%</div>
      <div class="pill" id="price">‚Çø0.00</div>
    </div>

    <div class="grid">
      <div class="card">
        <canvas id="chart" width="900" height="260"></canvas>
        <div class="tf">
          <button class="btn active" data-tf="1h">1h</button>
          <button class="btn" data-tf="1d">1d</button>
          <button class="btn" data-tf="1w">1w</button>
          <button class="btn" data-tf="1m">1m</button>
          <button class="btn" data-tf="all">All</button>
        </div>
      </div>

      <div class="card">
        <div class="field">
          <label>Koop ‚Äî bedrag in Bits</label>
          <input type="number" id="buyBits" min="1" value="10"/>
          <div class="small">Fee: <span id="feeBuy">0.50%</span></div>
          <div class="actions">
            <button class="btn buy" id="btnBuy">Kopen</button>
            <button class="btn swap" id="btnSwap">Swap naar‚Ä¶</button>
          </div>
        </div>

        <div class="field">
          <label>Verkoop ‚Äî aantal stuks</label>
          <input type="number" id="sellQty" min="1" value="1"/>
          <div class="actions">
            <button class="btn sell" id="btnSell">Verkopen</button>
          </div>
          <div class="small">Jouw positie: <span id="posInfo">0 stuks @ ‚Çø0.00</span></div>
        </div>

        <div class="field">
          <label>Storten/Opnemen (debug / event)</label>
          <div class="actions">
            <button class="btn" id="btnDeposit">+100 Bits</button>
            <button class="btn" id="btnWithdraw">-100 Bits</button>
          </div>
        </div>

        <div class="small" id="hint"></div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="title" style="font-size:18px">Over deze coin</div>
      <div id="about" class="small" style="margin-top:8px"></div>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const q = new URLSearchParams(location.search);
      const sym = q.get('symbol') || 'SNK';

      function setActiveTf(tf){
        document.querySelectorAll('.tf .btn').forEach(b=>{
          b.classList.toggle('active', b.dataset.tf===tf);
        });
      }

      function renderHeader(){
        document.getElementById('bitsHeader').textContent = Market.bits.get();
        const meta = Market.meta[sym] || {name:sym, ui:{icon:'üì¶'}};
        const a = Market.assets[sym];

        document.getElementById('icon').textContent = meta.ui.icon || 'üì¶';
        document.getElementById('name').textContent = meta.name || sym;
        document.getElementById('ticker').textContent = sym;
        document.getElementById('price').textContent = '‚Çø'+a.price.toFixed(2);

        const pct = ((a.price - a.yClose)/a.yClose)*100;
        const dd = document.getElementById('dayDelta');
        dd.textContent = (pct>=0?'+':'')+pct.toFixed(2)+'%';
        dd.className = 'pill ' + (pct>=0?'up':'down');

        document.getElementById('hint').textContent = meta.tagline + ' ‚Äî ' + meta.behavior;
        document.getElementById('about').innerHTML = `
          <div><strong>Volatiliteit:</strong> ${meta.volatility}</div>
          <div style="margin-top:6px">${meta.behavior}</div>
        `;

        const pos = Market.portfolio()[sym] || {qty:0, avg:0};
        document.getElementById('posInfo').textContent = `${pos.qty} stuks @ ‚Çø${pos.avg.toFixed(2)}`;
        document.getElementById('feeBuy').textContent = (Market.fee*100).toFixed(2)+'%';
      }

      // Simple sparkline (canvas)
      function drawChart(tf='1h'){
        const c = document.getElementById('chart');
        const ctx = c.getContext('2d');
        ctx.clearRect(0,0,c.width,c.height);

        const hist = Market.history(sym);
        if(!hist.length) return;

        let take = hist.length;
        const map = { '1h':120, '1d':720, '1w':720*5, '1m':720*20, 'all':hist.length };
        if(map[tf]) take = Math.min(map[tf], hist.length);
        const data = hist.slice(-take);

        const min = Math.min(...data);
        const max = Math.max(...data);
        const pad = 6;
        const W = c.width, H = c.height;

        // baseline
        ctx.globalAlpha = .15;
        ctx.strokeStyle = '#ffffff';
        ctx.beginPath();
        ctx.moveTo(pad, H/2);
        ctx.lineTo(W-pad, H/2);
        ctx.stroke();
        ctx.globalAlpha = 1;

        // line
        ctx.beginPath();
        data.forEach((v,i)=>{
          const x = pad + (i/(data.length-1))*(W-2*pad);
          const y = H - pad - ((v-min)/(max-min||1))*(H-2*pad);
          if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        });
        ctx.lineWidth = 2;
        ctx.strokeStyle = '#8a7cff';
        ctx.stroke();

        // last dot
        const last = data[data.length-1];
        const xLast = pad + (data.length-1)/(data.length-1)*(W-2*pad);
        const yLast = H - pad - ((last-min)/(max-min||1))*(H-2*pad);
        ctx.fillStyle = '#ffd66b';
        ctx.beginPath();
        ctx.arc(xLast,yLast,3,0,Math.PI*2);
        ctx.fill();
      }

      // TF buttons
      document.querySelectorAll('.tf .btn').forEach(b=>{
        b.onclick = ()=>{ setActiveTf(b.dataset.tf); drawChart(b.dataset.tf); };
      });

      // Actions
      document.getElementById('btnBuy').onclick = ()=>{
        const a = Market.assets[sym];
        const bits = Math.max(1, Math.floor(Number(document.getElementById('buyBits').value||0)));
        const qty = Math.floor(bits / (a.price*(1+Market.fee)));
        if(qty<=0){ alert('Te weinig Bits voor minimaal 1 stuk.'); return; }
        const res = Market.buy(sym, qty);
        if(!res.ok) alert(res.msg);
        renderHeader(); drawChart(document.querySelector('.tf .btn.active').dataset.tf);
      };

      document.getElementById('btnSell').onclick = ()=>{
        const qty = Math.max(1, Math.floor(Number(document.getElementById('sellQty').value||0)));
        const res = Market.sell(sym, qty);
        if(!res.ok) alert(res.msg);
        renderHeader(); drawChart(document.querySelector('.tf .btn.active').dataset.tf);
      };

      document.getElementById('btnDeposit').onclick = ()=>{ Market.bits.set(Market.bits.get()+100); renderHeader(); };
      document.getElementById('btnWithdraw').onclick = ()=>{ Market.bits.set(Math.max(0, Market.bits.get()-100)); renderHeader(); };

      document.getElementById('btnSwap').onclick = ()=>{
        const target = prompt('Swap naar symbol (bijv. SNK, FRIK, ...):','SNK');
        if(!target || !Market.assets[target]){ alert('Onbekende target.'); return; }
        const qty = Math.max(1, Math.floor(Number(prompt('Aantal te swappen (verkoop huidig, koop target):','1')||0)));
        const res = Market.swap(sym, target, qty);
        alert(res.msg);
        renderHeader(); drawChart(document.querySelector('.tf .btn.active').dataset.tf);
      };

      // loop
      function loop(){
        Market.tickAll();
        if(Math.random()<0.70){
          renderHeader();
          drawChart(document.querySelector('.tf .btn.active')?.dataset.tf || '1h');
        }
        requestAnimationFrame(loop);
      }

      // Init & first paint
      Market.init();              // zorgt voor assets + lange history
      setActiveTf('1h');
      renderHeader();
      drawChart('1h');
      loop();
    });
  </script>
</body>
</html>
